<style>
  .task-report-wrap { font-family: Arial, sans-serif; font-size: 10px; color: #1f2937; }
  .header { border-bottom: 2px solid #111827; padding-bottom: 8px; margin-bottom: 10px; }
  .title { margin: 0; font-size: 20px; font-weight: 700; }
  .subline { margin-top: 4px; color: #4b5563; }
  .filters { margin-top: 6px; color: #374151; }
  .filters span { margin-right: 14px; }

  .kpi-grid { width: 100%; border-collapse: separate; border-spacing: 8px; margin-top: 8px; margin-bottom: 10px; }
  .kpi-card { border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; background: #f9fafb; }
  .kpi-value { font-size: 18px; font-weight: 700; line-height: 1.2; }
  .kpi-label { color: #6b7280; margin-top: 2px; }

  .split { width: 100%; border-collapse: separate; border-spacing: 8px; margin-bottom: 8px; }
  .panel { border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; vertical-align: top; }
  .panel h3 { margin: 0 0 6px 0; font-size: 12px; }
  .mini-table { width: 100%; border-collapse: collapse; }
  .mini-table th, .mini-table td { border-bottom: 1px solid #e5e7eb; padding: 4px; text-align: left; }
  .mini-table th { color: #374151; }

  .section { margin-top: 10px; }
  .section-title { margin: 0 0 6px 0; font-size: 13px; border-left: 4px solid #9ca3af; padding-left: 6px; }
  .section-title.upcoming { border-left-color: #f59e0b; }
  .section-title.overdue { border-left-color: #ef4444; }
  .section-title.other { border-left-color: #6b7280; }

  .task-table { width: 100%; border-collapse: collapse; }
  .task-table th, .task-table td { border: 1px solid #e5e7eb; padding: 5px; text-align: left; vertical-align: top; }
  .task-table th { background: #f3f4f6; font-weight: 700; }
  .empty-row { color: #6b7280; font-style: italic; }
  .row-overdue { background: #fef2f2; }
  .row-upcoming { background: #fffbeb; }

  .badge { display: inline-block; border-radius: 10px; padding: 1px 6px; font-size: 9px; font-weight: 700; }
  .badge-urgent { background: #fee2e2; color: #991b1b; }
  .badge-high { background: #ffedd5; color: #9a3412; }
  .badge-medium { background: #dbeafe; color: #1e3a8a; }
  .badge-low { background: #dcfce7; color: #166534; }
</style>

<div class="task-report-wrap">
  <div class="header">
    <h2 class="title">Daily Task Report</h2>
    <div class="subline">
      Report Date: {{ frappe.utils.formatdate(report_date) }} | Generated At: {{ frappe.utils.format_datetime(generated_on) }} | Generated By: {{ generated_by }}
    </div>
    <div class="filters">
      <span><strong>User:</strong> {{ selected_user or "All" }}</span>
      <span><strong>Project:</strong> {{ selected_project or "All" }}</span>
      <span><strong>Priority:</strong> {{ selected_priority or "All" }}</span>
    </div>
  </div>

  <table class="kpi-grid">
    <tr>
      {% for item in summary %}
      <td class="kpi-card">
        <div class="kpi-value">{{ item.value }}</div>
        <div class="kpi-label">{{ item.label }}</div>
      </td>
      {% endfor %}
    </tr>
  </table>

  <table class="split">
    <tr>
      <td class="panel" style="width: 40%;">
        <h3>Bucket Overview</h3>
        <table class="mini-table">
          <thead>
            <tr>
              <th>Bucket</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Upcoming (2 Days)</td><td>{{ bucket_counter.get("Upcoming (2 Days)", 0) }}</td></tr>
            <tr><td>Overdue</td><td>{{ bucket_counter.get("Overdue", 0) }}</td></tr>
            <tr><td>Other Active Tasks</td><td>{{ bucket_counter.get("Other Active Tasks", 0) }}</td></tr>
          </tbody>
        </table>
      </td>
      <td class="panel" style="width: 60%;">
        <h3>Top Attention Items</h3>
        <table class="mini-table">
          <thead>
            <tr>
              <th>Task</th>
              <th>Priority</th>
              <th>Bucket</th>
              <th>Due</th>
            </tr>
          </thead>
          <tbody>
            {% if highlights %}
              {% for task in highlights %}
              <tr>
                <td>{{ task.name }}</td>
                <td>{{ task.priority }}</td>
                <td>{{ task.bucket }}</td>
                <td>{{ frappe.utils.formatdate(task.due_date) if task.due_date else "-" }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4" class="empty-row">No high-attention tasks in this run.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </td>
    </tr>
  </table>

  {% for section_name in ["Upcoming (2 Days)", "Overdue", "Other Active Tasks"] %}
  <div class="section">
    <h3 class="section-title {% if section_name == 'Upcoming (2 Days)' %}upcoming{% elif section_name == 'Overdue' %}overdue{% else %}other{% endif %}">
      {{ section_name }} ({{ sections.get(section_name, [])|length }})
    </h3>
    <table class="task-table">
      <thead>
        <tr>
          <th style="width: 10%;">Task</th>
          <th style="width: 24%;">Subject</th>
          <th style="width: 9%;">Project</th>
          <th style="width: 8%;">Status</th>
          <th style="width: 9%;">Priority</th>
          <th style="width: 8%;">Due Date</th>
          <th style="width: 7%;">Days</th>
          <th style="width: 10%;">Previous</th>
          <th style="width: 15%;">Assignees</th>
        </tr>
      </thead>
      <tbody>
        {% if sections.get(section_name) %}
          {% for task in sections.get(section_name) %}
          <tr class="{% if task.bucket == 'Overdue' %}row-overdue{% elif task.bucket == 'Upcoming (2 Days)' %}row-upcoming{% endif %}">
            <td>{{ task.name }}</td>
            <td>{{ task.subject or "" }}</td>
            <td>{{ task.project or "" }}</td>
            <td>{{ task.status or "" }}</td>
            <td>
              {% if task.priority == "Urgent" %}
                <span class="badge badge-urgent">Urgent</span>
              {% elif task.priority == "High" %}
                <span class="badge badge-high">High</span>
              {% elif task.priority == "Medium" %}
                <span class="badge badge-medium">Medium</span>
              {% elif task.priority == "Low" %}
                <span class="badge badge-low">Low</span>
              {% else %}
                {{ task.priority or "" }}
              {% endif %}
            </td>
            <td>{{ frappe.utils.formatdate(task.due_date) if task.due_date else "-" }}</td>
            <td>{{ task.days_to_due if task.days_to_due is not none else "-" }}</td>
            <td>{{ task.previous_status or "-" }}</td>
            <td>{{ task.assignees or "-" }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td class="empty-row" colspan="9">No tasks in this section.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  {% endfor %}
</div>
